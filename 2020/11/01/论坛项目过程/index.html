<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="数据库表用户表 user   字段 类型 备注    id int 主键、自增   username varchar 用户名，创建索引   password varchar 用户密码   salt varchar 加密盐值   email varchar 用户邮箱，创建索引   type int 用户类型：0 普通、1 管理员、2 版主   status int 用户状态：0 未激活、1 已激活">
<meta property="og:type" content="article">
<meta property="og:title" content="论坛项目过程">
<meta property="og:url" content="http://aamingaa.github.io/2020/11/01/%E8%AE%BA%E5%9D%9B%E9%A1%B9%E7%9B%AE%E8%BF%87%E7%A8%8B/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="数据库表用户表 user   字段 类型 备注    id int 主键、自增   username varchar 用户名，创建索引   password varchar 用户密码   salt varchar 加密盐值   email varchar 用户邮箱，创建索引   type int 用户类型：0 普通、1 管理员、2 版主   status int 用户状态：0 未激活、1 已激活">
<meta property="article:published_time" content="2020-11-01T02:41:13.000Z">
<meta property="article:modified_time" content="2020-11-01T02:42:01.140Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://aamingaa.github.io/2020/11/01/论坛项目过程/"/>





  <title>论坛项目过程 | Hexo</title>
  








<meta name="generator" content="Hexo 4.2.1"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Hexo</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://aamingaa.github.io/2020/11/01/%E8%AE%BA%E5%9D%9B%E9%A1%B9%E7%9B%AE%E8%BF%87%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avator.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">论坛项目过程</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-11-01T10:41:13+08:00">
                2020-11-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AE%BE%E8%AE%A1%E9%A2%98/" itemprop="url" rel="index">
                    <span itemprop="name">设计题</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  6.1k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  23
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="数据库表"><a href="#数据库表" class="headerlink" title="数据库表"></a>数据库表</h2><h4 id="用户表-user"><a href="#用户表-user" class="headerlink" title="用户表 user"></a>用户表 user</h4><table>
<thead>
<tr>
<th>字段</th>
<th>类型</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>int</td>
<td>主键、自增</td>
</tr>
<tr>
<td>username</td>
<td>varchar</td>
<td>用户名，创建索引</td>
</tr>
<tr>
<td>password</td>
<td>varchar</td>
<td>用户密码</td>
</tr>
<tr>
<td>salt</td>
<td>varchar</td>
<td>加密盐值</td>
</tr>
<tr>
<td>email</td>
<td>varchar</td>
<td>用户邮箱，创建索引</td>
</tr>
<tr>
<td>type</td>
<td>int</td>
<td>用户类型：0 普通、1 管理员、2 版主</td>
</tr>
<tr>
<td>status</td>
<td>int</td>
<td>用户状态：0 未激活、1 已激活</td>
</tr>
<tr>
<td>activation_code</td>
<td>varchar</td>
<td>激活码</td>
</tr>
<tr>
<td>header_url</td>
<td>varchar</td>
<td>用户头像地址</td>
</tr>
<tr>
<td>create_time</td>
<td>timestamp</td>
<td>注册时间</td>
</tr>
</tbody></table>
<h4 id="评论表-comment"><a href="#评论表-comment" class="headerlink" title="评论表 comment"></a>评论表 comment</h4><table>
<thead>
<tr>
<th>字段</th>
<th>类型</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>int</td>
<td>主键、自增</td>
</tr>
<tr>
<td>user_id</td>
<td>int</td>
<td>评论的用户 id，创建索引</td>
</tr>
<tr>
<td>entity_id</td>
<td>int</td>
<td>评论实体 id，创建索引</td>
</tr>
<tr>
<td>entity_type</td>
<td>int</td>
<td>评论实体类型：1 帖子评论、2 评论回复</td>
</tr>
<tr>
<td>target_id</td>
<td>int</td>
<td>评论目标 id</td>
</tr>
<tr>
<td>content</td>
<td>text</td>
<td>评论内容</td>
</tr>
<tr>
<td>status</td>
<td>int</td>
<td>评论状态：0 有效、1 无效</td>
</tr>
<tr>
<td>create_time</td>
<td>timestamp</td>
<td>评论发表时间</td>
</tr>
</tbody></table>
<h4 id="帖子表-discuss-post"><a href="#帖子表-discuss-post" class="headerlink" title="帖子表 discuss_post"></a>帖子表 discuss_post</h4><table>
<thead>
<tr>
<th>字段</th>
<th>类型</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>int</td>
<td>主键、自增</td>
</tr>
<tr>
<td>user_id</td>
<td>int</td>
<td>发帖的用户 id，创建索引</td>
</tr>
<tr>
<td>title</td>
<td>varchar</td>
<td>帖子表标题</td>
</tr>
<tr>
<td>content</td>
<td>text</td>
<td>帖子内容</td>
</tr>
<tr>
<td>type</td>
<td>int</td>
<td>帖子类型：0 普通、1 置顶</td>
</tr>
<tr>
<td>comment_count</td>
<td>int</td>
<td>评论数量</td>
</tr>
<tr>
<td>status</td>
<td>int</td>
<td>帖子状态：0 普通、1 精华、2 拉黑</td>
</tr>
<tr>
<td>create_time</td>
<td>timestamp</td>
<td>评论发表时间</td>
</tr>
</tbody></table>
<h4 id="用户登录凭证表-login-ticket"><a href="#用户登录凭证表-login-ticket" class="headerlink" title="用户登录凭证表 login_ticket"></a>用户登录凭证表 login_ticket</h4><table>
<thead>
<tr>
<th>字段</th>
<th>类型</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>int</td>
<td>主键、自增</td>
</tr>
<tr>
<td>user_id</td>
<td>int</td>
<td>登录用户 id</td>
</tr>
<tr>
<td>ticket</td>
<td>varchar</td>
<td>登录凭证，随机字符串</td>
</tr>
<tr>
<td>status</td>
<td>int</td>
<td>登录状态：0 有效、1 无效</td>
</tr>
<tr>
<td>expired</td>
<td>timestamp</td>
<td>过期时间</td>
</tr>
</tbody></table>
<h4 id="消息表-message"><a href="#消息表-message" class="headerlink" title="消息表 message"></a>消息表 message</h4><table>
<thead>
<tr>
<th>字段</th>
<th>类型</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>int</td>
<td>主键、自增</td>
</tr>
<tr>
<td>from_id</td>
<td>int</td>
<td>发消息的 id，创建索引</td>
</tr>
<tr>
<td>to_id</td>
<td>int</td>
<td>收消息的 id，创建索引</td>
</tr>
<tr>
<td>conversation_id</td>
<td>varchar</td>
<td>会话 id，由通信双方 id 拼接，创建索引</td>
</tr>
<tr>
<td>content</td>
<td>text</td>
<td>消息内容</td>
</tr>
<tr>
<td>status</td>
<td>int</td>
<td>消息状态：0 未读、1 已读、2 删除</td>
</tr>
<tr>
<td>create_time</td>
<td>timestamp</td>
<td>消息发送时间</td>
</tr>
</tbody></table>
<hr>
<h2 id="开发社区首页"><a href="#开发社区首页" class="headerlink" title="开发社区首页"></a>开发社区首页</h2><h3 id="搭建基本环境"><a href="#搭建基本环境" class="headerlink" title="搭建基本环境"></a>搭建基本环境</h3><p>构建 SpringBoot 的 maven 项目，引入 mysql 和 mybatis 依赖。</p>
<hr>
<p>在 <code>application.properties</code> 配置文件中：</p>
<ul>
<li>关闭 thymeleaf 缓存</li>
<li>配置数据库，设置基本连接信息、最大线程数，最小空闲线程数，最大空闲时间等</li>
<li>mybatis，设置 mapper 文件的位置、实体类包名、使用主键等</li>
</ul>
<hr>
<p>创建 community 数据库和数据库表。</p>
<hr>
<p>用户相关操作：</p>
<ul>
<li>创建对应 user 表的 User 实体类</li>
<li>创建 UserMapper 接口，使用 <code>@Mapper</code> 注解</li>
<li>创建 user-mapper.xml，重复 sql 语句可以写在 <code>&lt;sql id = &quot;xxx&quot;&gt;</code> 标签，通过 <code>&lt;include refid=&quot;xxx&quot;/&gt;</code> 引用。</li>
</ul>
<hr>
<h3 id="开发社区首页（discuss-post-表）"><a href="#开发社区首页（discuss-post-表）" class="headerlink" title="开发社区首页（discuss_post 表）"></a>开发社区首页（discuss_post 表）</h3><p>功能拆分：开发社区首页，显示前 10 个帖子。开发分页组件，分页显示所有帖子。</p>
<p>用到的表是 discuss_post 数据库表，包括帖子 id、发帖人 id、标题、内容、类型、状态、发帖时间、评论数量（为了提高效率，避免关联查询，因此冗余存储）、分数（用于进行热度排名）。</p>
<h4 id="开发数据层"><a href="#开发数据层" class="headerlink" title="开发数据层"></a>开发数据层</h4><p>帖子相关操作：</p>
<ul>
<li><p>创建对应 discuss_post 表的 DisscussPost 实体类。</p>
</li>
<li><p>创建 DisscussPostMapper 接口，使用 <code>@Mapper</code> 注解。</p>
<ul>
<li>分页查询中用户 id 是可选参数，通过动态 SQL 选择，如果为 0 就不使用，在开发用户个人主页查询用户发帖记录时需要使用。</li>
<li>如果只有一个参数，并且在动态 SQL 的 <code>&lt;if&gt;</code> 里使用，必须使用 <code>@Param</code> 加别名。</li>
</ul>
</li>
<li><p>创建 <code>disscusspost-mapper.xml</code>。</p>
<ul>
<li><p><code>where status != 2</code> 拉黑的帖子不展现。</p>
</li>
<li><p><code>&lt;if test=&quot;userId!=0&quot;&gt;</code>  userID 为 0 时不使用，按照类型，发帖时间排序。</p>
</li>
</ul>
</li>
</ul>
<hr>
<h4 id="开发业务层"><a href="#开发业务层" class="headerlink" title="开发业务层"></a>开发业务层</h4><p>创建 DiscussPostService 类，可以分页查询帖子和帖子数量。</p>
<p>创建 UserService 类，实现根据 id 查询用户功能，因为显示帖子时不显示用户 id，而是显示用户名。</p>
<hr>
<h4 id="开发视图层"><a href="#开发视图层" class="headerlink" title="开发视图层"></a>开发视图层</h4><p>把静态资源 css、html、img、js 放到 static 目录下。</p>
<p>把模板 mail、site、index.html 放到 template 目录下。</p>
<p>创建 HomeController，<code>getIndexPage</code> 方法，用 map 集合把帖子和用户封装到一起。</p>
<p>修改 <code>index.html</code>，使用 <code>&lt;th:text=&quot;${map.xxx.xxx}&quot;</code> 动态替换。</p>
<p>【问题】使用帖子关联查询用户时，给查询用户的 <code>findUserById</code> 方法传入了帖子的 <code>getId</code> 方法，应该是 <code>getUserId</code> 方法。</p>
<hr>
<h4 id="开发分页组件"><a href="#开发分页组件" class="headerlink" title="开发分页组件"></a>开发分页组件</h4><p>创建 Page 实体类，封装分页信息，包括当前页码、显示限制、帖子总数、查询路径等。显示的起始页不能小于 1，最大页不能超过 total。</p>
<p>在 <code>index.html</code> 中，当 <code>page.rows &gt; 0</code> 时显示分页信息。</p>
<p>如果 <code>page.current</code>  等于 1 或 <code>page.total</code>，代表是首页或末页，此时不能点击上一页和下一页，用 <code>disabled</code> 属性实现。</p>
<hr>
<h2 id="开发注册登录模块"><a href="#开发注册登录模块" class="headerlink" title="开发注册登录模块"></a>开发注册登录模块</h2><hr>
<h3 id="发送邮件"><a href="#发送邮件" class="headerlink" title="发送邮件"></a>发送邮件</h3><p>在新浪邮箱打开 SMTP 服务。</p>
<p>引入 <code>spring-boot-starter-mail</code> 依赖。</p>
<p>在配置文件配置主机、端口、发送邮箱、授权码等。</p>
<p>创建 MailClient 类，调用 JavaMailSender 发送邮件。</p>
<p>使用 thymeleaf 发送 HTML 邮件，调用 TemplateEngine 把信息封装到 HTML 模板。</p>
<p>【问题】发送邮件成功但没接收到，在垃圾箱中可找到。</p>
<hr>
<h3 id="注册功能"><a href="#注册功能" class="headerlink" title="注册功能"></a>注册功能</h3><p>把 register.html 地址关联到首页的注册 href 属性。</p>
<p>设置域名、创建 CommunityUtil 工具类，在工具类创建生产随机字符串和 MD5 加密方法。</p>
<p>创建 LoginController，创建 <code>getRegisterPage</code> 方法，跳转注册页面。</p>
<p>在 UserService 中创建 <code>register</code> 方法，判断注册信息合规后插入数据库，发送激活邮件。</p>
<p>在 LoginController 创建 <code>register</code> 方法，调用 UserService 的 <code>register</code> 方法。</p>
<p>创建接口 CommunityConstant，定义激活码的三种状态，成功、重复、失败，让 UserService 和 LoginController 实现该接口。</p>
<p>点击激活邮件的 url 【本地服务器的url】后，服务器通过 LoginController 的 <code>activation</code> 方法查询数据库用户，如果 url 中的激活码和设置的一样，就把用户 status 改为 1。</p>
<hr>
<h3 id="生成验证码"><a href="#生成验证码" class="headerlink" title="生成验证码"></a>生成验证码</h3><p>在 <code>pom.xml</code> 导入 kaptcha 的 jar 包。</p>
<p>创建配置类 KaptchaConfig，设置验证码的大小、范围、长度等。</p>
<p>在 LoginController 类新增 <code>getKaptcha</code> 方法生成验证码图片。</p>
<p>在 <code>login.html</code> 中，将刷新验证码的链接绑定 <code>refresh_kaptcha</code> 方法，通过 id 选择器获取 img 组件，重新访问  <code>getKaptcha</code> 方法生成验证码图片。</p>
<p>【问题】由于访问同一个生成验证码路径，需要在 url 参数加上一个随机数字，保证会重新请求获取新图片。</p>
<hr>
<h3 id="登录退出功能（login-ticket-表）"><a href="#登录退出功能（login-ticket-表）" class="headerlink" title="登录退出功能（login_ticket 表）"></a>登录退出功能（login_ticket 表）</h3><p>登录成功时，需要生成一个登录凭证发送给客户端。凭证可以在多个业务中连续地验证用户的登陆状态，凭证信息存储在 login_ticket 数据库表中，status 的 0 和 1 表示有效和无序，expire 表示过期时间。</p>
<p>创建对应 login_ticket 表的 LoginTicket 实体类，对应 login_ticket 数据库表。</p>
<p>创建 LoginTicketMapper 接口，通过 <code>@Insert</code>、<code>@Select</code>、<code>@Update</code> 注解来插入、查询、更新凭证。</p>
<p>在 UserServce </p>
<ul>
<li><p>创建 <code>login</code> 方法，验证账户合规后将凭证信息插入数据库，添加登录凭证到 map 中。</p>
</li>
<li><p>创建 <code>logout</code> 方法，将对应凭证设为无效。</p>
</li>
</ul>
<p>在 LoginController </p>
<ul>
<li><p>创建 <code>login</code> 方法，判断验证码正确后调用  UserServce 的 <code>login</code> 方法，如果 map 包含 ticket 代表登录成功，重定向跳转首页，否则添加错误信息并跳回登录页。</p>
</li>
<li><p>创建 <code>logout</code> 方法，判断验证码正确后调用  UserServce 的<code>logout</code> 方法，跳转至登录页。</p>
</li>
</ul>
<p>在 <code>login.html</code> 绑定登录链接，<code>index.html</code> 绑定退出登录链接。</p>
<p>【问题】登录成功后，创建了凭证，但忘记将凭证信息插入数据库。</p>
<hr>
<h3 id="显示登录信息"><a href="#显示登录信息" class="headerlink" title="显示登录信息"></a>显示登录信息</h3><p>创建 CookieUtil 工具类，通过 name 查询对应 cookie 的 value。</p>
<p>在 UserService 中新增 <code>findLoginTicket</code> 方法，根据 ticket 查询 LoginTicket。</p>
<p>创建 HostHolder 类用来模拟 session 的功能，利用 ThreadLocal 实现，存储用户信息。</p>
<p>创建 LoginTicketInterceptor 拦截器，实现 HandlerInterceptor 接口。</p>
<ul>
<li>在 <code>preHandle</code> 方法中通过 CookieUtil 的 <code>getValue</code> 方法查询是否有凭证 cookie，如果有则通过 UserService 的  <code>findloginTicket</code> 方法查询用户 ID，再通过用户 ID 查询用户。最后将用户放入 hostHolder 中。</li>
<li>在 <code>postHandle</code> 方法中通过 hostHolder 的 <code>get</code> 方法获取用户，并将其存入视图中。</li>
<li>在 <code>afterCompletion</code> 方法中清除 hostHolder 中存放的用户信息。</li>
</ul>
<p>创建 WebMvcConfig 配置类，实现 WebMvcConfigurer接口，配置 LoginTicketInterceptor，拦截除了静态资源之外的所有路径。</p>
<hr>
<h3 id="上传头像"><a href="#上传头像" class="headerlink" title="上传头像"></a>上传头像</h3><p>在 UserService 新增 <code>updateHeader</code> 方法，更改指定用户的头像。</p>
<p>创建 UserController</p>
<ul>
<li><p>新增 <code>getSettingPage</code> 方法访问账户设置 <code>setting.html</code> ，并在 <code>index.html</code> 的账号设置按钮关联该链接。</p>
</li>
<li><p>新增 <code>uploadHeader</code> 方法更新用户头像，如果上传出现错误将错误信息存在 Model 对象中。</p>
<p>如果没有错误，生成一个文件对象 dest，利用 MultipartFile 接口的 <code>transferTo</code> 方法将用户上传文件导入 dest，并从 hostHolder 中取出用户，更新用户的头像路径。</p>
</li>
<li><p>新增 <code>getHeader</code> 方法获取用户头像，利用文件输入流读取图片数据，利用 HttpServletResponse 的字节输出流再进行输出。</p>
</li>
</ul>
<p>调整 <code>setting.html</code> 的 form 表单， method=”post”，enctype=”multipart/form-data”，并设置提交路径。</p>
<hr>
<h3 id="修改密码"><a href="#修改密码" class="headerlink" title="修改密码"></a>修改密码</h3><p>在 UserService 中新增 <code>changePassword</code> 方法，判断原密码是否正确，正确则修改密码并返回 1，否则返回 0。</p>
<p>在 UserController 中新增 <code>changePassword</code> 方法，根据 UserService 的  <code>changePassword</code> 方法的返回值判断原密码是否成功修改，封装为 JSON 数据并返回。</p>
<p>在 <code>setting.html</code> 中</p>
<ul>
<li>首先在前端判断两次输入的新密码是否一致，如果不一致不允许点击提交并显示错误信息。</li>
<li>利用 ajax 向 UserController 的  <code>changePassword</code> 方法发送 POST 请求，得到 JSON 数据并解析，如果状态码为 0 提示错误，如果状态码为 1 弹出修改成功提示。</li>
</ul>
<p>【问题】js 的虚拟路径问题，需要加上 <code>../</code>。</p>
<p>【问题】使用 ajax 请求时，表单按钮类型必须是 button，不能是 submit，否则 405 报错。</p>
<p>【问题】使用 ajax 请求时，Controller 中方法的返回值必须是 JSON 数据，并且需要加上 <code>@ResponseBody</code>。</p>
<p>【问题】使用 ajax 请求时，回调函数需要先对返回的 JSON 数据进行解析再使用。</p>
<hr>
<h3 id="检查登录状态"><a href="#检查登录状态" class="headerlink" title="检查登录状态"></a>检查登录状态</h3><p>利用拦截器，实现只处理带有自定义注解的方法，防止用户在未登录情况下通过 url 访问没有权限的页面。</p>
<p>创建 <code>@LoginRequired</code> 自定义注解，作用范围在方法上，有效期为运行时。</p>
<p>在 UserController 中需要在登录状态下调用的方法，访问设置页面、修改密码、上传头像等加上自定义注解。</p>
<p>创建 LoginRequiredInterceptor 拦截器，在 <code>preHandle</code> 方法中判断方法是否加了 <code>@LoginRequired</code> 注解，如果加了注解并且此时从 hostHolder 中获取不到用户则拒绝访问。</p>
<p>在 WebMvcConfig 配置类配置 LoginRequiredInterceptor，拦截除了静态资源之外的所有路径。</p>
<hr>
<h2 id="开发核心功能"><a href="#开发核心功能" class="headerlink" title="开发核心功能"></a>开发核心功能</h2><h3 id="敏感词过滤"><a href="#敏感词过滤" class="headerlink" title="敏感词过滤"></a>敏感词过滤</h3><p>利用字典树数据结构解决。</p>
<p>创建 SensitiveFilter 类</p>
<ul>
<li>创建静态内部类 TrieNode ，通过 boolean 类型的结束符判断是否匹配到关键字尾部。</li>
<li>利用 <code>@PostConstruct</code> 注解，在构造方法执行后初始化字典树。</li>
<li>添加 <code>filter</code> 方法，利用双指针进行匹配，过滤敏感词。</li>
</ul>
<p>【问题】判断子节点空时，直接添加了一个 new 的子节点，没有将对象赋值给子节点变量。</p>
<hr>
<h3 id="发布帖子"><a href="#发布帖子" class="headerlink" title="发布帖子"></a>发布帖子</h3><p>引入 fastjson 依赖，在 CommunityUtil 中新增 <code>getJSONString</code> 方法封装 JSON 信息。</p>
<p>在 DisscussPostMapper 接口新增 <code>insertDiscussPost</code> 方法，并在 <code>disscusspost-mapper.xml</code> 配置 insert 语句。</p>
<p>在 DiscussPostService 新增 <code>addDiscussPost</code> 方法调用 DisscussPostMapper 的 <code>insertDiscussPost</code> 方法，其中需要进行对标题内容和发帖内容进行 HTML 转义以及过滤敏感词。</p>
<p>创建 DiscussPostController 类，新增 <code>addDiscussPost</code> 方法，调用 DiscussPostService 的 <code>addDiscussPost</code> 方法发帖。</p>
<p>在 <code>index.html</code> 中为发帖按钮绑定函数，利用 Ajax 向 DiscussPostController 的 <code>addDiscussPost</code> 方法发送 POST 请求。</p>
<hr>
<h3 id="显示帖子内容"><a href="#显示帖子内容" class="headerlink" title="显示帖子内容"></a>显示帖子内容</h3><p>在 DisscussPostMapper 接口新增 <code>selectDiscussPostById</code> 方法，在 <code>disscusspost-mapper.xml</code> 配置 select 语句。</p>
<p>在 DiscussPostService 新增 <code>findDiscussPostById</code> 方法调用 DisscussPostMapper 的 <code>selectDiscussPostById</code> 方法。</p>
<p>在 DiscussPostController 新增 <code>getDiscussPost</code> 方法，调用 DiscussPostService 的 <code>findDiscussPostById</code> 方法查询帖子内容，将 DiscussPost 对象和 User 对象（通过 userId 查询，不在 DAO 层关联查询）数据存放到 Model 对象，返回模板 <code>discuss-detail</code>。</p>
<p>在 <code>discuss-detail.html</code> 取出 Model 对象存放的数据绑定到对应组件显示。</p>
<hr>
<h3 id="显示评论（comment-表）"><a href="#显示评论（comment-表）" class="headerlink" title="显示评论（comment 表）"></a>显示评论（comment 表）</h3><p>创建 comment 表对应的实体类 Comment。</p>
<p>创建 CommentMapper 接口</p>
<ul>
<li>新增 <code>selectCommentsByEntity</code> 方法，根据实体查询一页的评论数据。</li>
<li>新增 <code>selectCountByEntity</code> 方法，根据实体查询评论的数量。</li>
<li>在 <code>comment-mapper.xml</code> 配置 select 语句。</li>
</ul>
<p>创建 CommentService 类</p>
<ul>
<li>新增 <code>findCommentByEntity</code> 方法，调用 CommentMapper 的 <code>selectCommentByEntity</code> 方法。</li>
<li>新增 <code>findCommentCount</code> 方法，调用 CommentMapper 的 <code>selectCountByEntity</code> 方法。</li>
</ul>
<p>在 DiscussPostController 的 <code>getDiscussPost</code> 方法中增加查询帖子评论和回复的逻辑，将结果存储在 Model 对象。</p>
<p>【问题】sql 的 xml 文件中绑定参数时，应传入实体类属性名，拼错成数据库字段名（entityId 写成 entity_id）。</p>
<hr>
<h3 id="添加评论"><a href="#添加评论" class="headerlink" title="添加评论"></a>添加评论</h3><p>在 CommentMapper 接口新增 <code>insertComment</code> 方法，添加评论数据，在 <code>comment-mapper</code> 配置对应 sql。</p>
<p>在 DiscussPostMapper 接口新增 <code>updateCommentCount</code> 方法，增加评论数量，在 <code>discusspost-mapper</code> 配置对应 sql。</p>
<p>在 DiscussPostService 类新增 <code>updateCommentCount</code> 方法，调用 DiscussPostMapper 的 <code>updateCommentCount</code> 方法。</p>
<p>在 CommentService 类新增 <code>addComment</code> 方法，调用 CommentMapper 的 <code>insertComment</code> 新增评论，并调用 DiscussPostService 的 <code>updateCommentCount</code> 更新评论数量，使用 <code>@Transactional</code> 注解保证事务。</p>
<p>创建 CommentController 类，新增 <code>addComment</code> 方法，从 hostHolder 获取用户信息，然后调用 CommentService 的 <code>addComment</code> 方法添加评论。</p>
<p>【问题】sql 的 xml 文件中绑定参数时，应传入实体类属性名，拼错成数据库字段名（entityId 写成 entity_id）。</p>
<hr>
<h3 id="显示私信列表-（message-表）"><a href="#显示私信列表-（message-表）" class="headerlink" title="显示私信列表 （message 表）"></a>显示私信列表 （message 表）</h3><p>创建对应 message 表的实体类 Message。</p>
<p>创建 MessageMapper 接口，增加查询会话列表、会话数量、私信列表、私信数量、未读私信数量等方法，在 <code>message-mapper.xml</code> 中配置对应的 sql。</p>
<p>创建 MessageService，调用 MessageMapper 中的方法。</p>
<p>创建 MessgaeController</p>
<ul>
<li>新增 <code>getLetterList</code> 方法，将会话列表信息存储到 Model 对象，返回 <code>letter</code> 视图。</li>
<li>新增 <code>getLetterDetail</code> 方法，将每个会话具体的私信信息存储到 Model 对象，返回 <code>letter-datail</code> 视图。</li>
</ul>
<hr>
<h3 id="发送私信"><a href="#发送私信" class="headerlink" title="发送私信"></a>发送私信</h3><p>在 MessageMapper </p>
<ul>
<li>新增 <code>insertMessage</code> 方法插入私信记录，在 <code>message-mapper.xml</code>  配置 insert 语句。</li>
<li>新增 <code>updateMessgae</code> 方法修改私信状态，在 <code>message-mapper.xml</code>  配置 update 语句，利用 foreach 动态 sql。</li>
</ul>
<p>在 MessageService</p>
<ul>
<li><p>新增 <code>addMessage</code> 发送私信方法，过滤敏感词后，调用 MessageMapper 的 <code>insertMessage</code> 。</p>
</li>
<li><p>新增 <code>readMessage</code> 方法读取信息，调用MessageMapper 的 <code>updateMessgae</code> 更新私信的状态为 1。</p>
</li>
</ul>
<p>在 MessageController </p>
<ul>
<li><p>新增 <code>getLetterIds</code> 方法，将私信集合中未读私信的 id 添加到 List 集合并返回，在 <code>getLetterDetail</code> 方法调用该方法设置已读。</p>
</li>
<li><p>新增 <code>sendLetter</code> 发送私信方法，设置私信信息后调用 MessageService 的 <code>addMessage</code> 发送。</p>
</li>
</ul>
<hr>
<h3 id="统一异常处理"><a href="#统一异常处理" class="headerlink" title="统一异常处理"></a>统一异常处理</h3><p>在 HomeController 中增加 <code>getErrorPage</code> 方法，返回错误页面。</p>
<p>创建 ExceptionAdvice 类</p>
<ul>
<li>加上 <code>@ControllerAdvice</code> 注解，表示该类是 Controller 的全局配置类。</li>
<li>创建 <code>handleException</code> 方法，加上 <code>@ExceptionHandler</code> 注解，该方法在 Controller 出现异常后调用，处理捕获异常。如果是异步请求返回一个 JSON 数据，否则重定向至 HomeController 的 <code>getErrorPage</code> 方法。</li>
</ul>
<hr>
<h3 id="统一日志处理"><a href="#统一日志处理" class="headerlink" title="统一日志处理"></a>统一日志处理</h3><p>在 <code>pom.xml</code> 引入 aspectj 的依赖。</p>
<p>创建 ServiceLogAspect 类，添加 <code>@Aspect</code> 切面注解，配置切入点表达式，拦截所有 service 包下的方法，利用 <code>@Before</code> 记录日志。</p>
<hr>
<h2 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h2><h3 id="点赞"><a href="#点赞" class="headerlink" title="点赞"></a>点赞</h3><p>创建 RedisKeyUtil 工具类</p>
<ul>
<li>定义分隔符 <code>:</code> 以及实体获得赞的 key 前缀常量 <code>like:entity</code>。</li>
<li>新增 <code>getEntityLikeKey(int entityType,int entityId)</code> 方法，通过实体类型和实体 id 生成对应实体获得赞的 key。</li>
</ul>
<p>创建业务层的 LikeService 类</p>
<ul>
<li><p>注入 RedisTemplate 实例。</p>
</li>
<li><p>新增 <code>like</code> 点赞方法，首先通过 RedisKeyUtil 工具类的  <code>getEntityLikeKey</code> 方法获得实体点赞的 key，然后通过 RedisTemplate 对象对 set 集合的 <code>isMember</code> 方法查询 userId 是否存在于对应 key 的 set 集合中，如果存在则移除出点赞的用户集合，如果不存在则添加到点赞的用户集合。</p>
</li>
<li><p>新增 <code>findEntityLikeCount</code> 方法查询实体的点赞数量，通过调用 set 集合的 <code>size</code> 方法查询元素个数。</p>
</li>
<li><p>新增 <code>findEntityLikeStatus</code> 方法查询某用户对某实体的点赞状态，逻辑如 <code>like</code> 方法，通过 set 集合的 <code>isMember</code> 方法实现。</p>
</li>
</ul>
<p>创建表现层的 LikeController 类</p>
<ul>
<li>注入 LikeService 和 HostHolder 实例。</li>
<li>新增 <code>like</code> 点赞方法，调用业务层的 <code>like</code> 方法进行点赞、调用  <code>findEntityLikeCount</code> 和 <code>findEntityLikeStatus</code>  查询点赞数量和点赞状态，封装到 map 集合，然后通过工具类封装成 JSON 数据返回。</li>
</ul>
<p>（更新首页帖子点赞数量）在表现层的 HomeController 类</p>
<ul>
<li>注入 LikeService 实例。</li>
<li>在 <code>getIndexPage</code> 方法在通过 LikeService 类的方法获得点赞数量，存储到 map 集合。</li>
</ul>
<hr>
<h3 id="收到的赞"><a href="#收到的赞" class="headerlink" title="收到的赞"></a>收到的赞</h3><p>对点赞功能进行重构</p>
<p>在 RedisUnitl 工具类</p>
<ul>
<li><p>新增用户获得赞 key 的前缀常量 <code>like:user</code></p>
</li>
<li><p>新增 <code>getUserLikeKey(int userId)</code> 方法，通过用户 id 生成对应用户获得赞的 key。</p>
</li>
</ul>
<p>在 LikeService 中</p>
<ul>
<li><p>重构 <code>like</code> 方法，在参数列表中加入 entityUserId 表示被点赞用户的 id，用来更新用户的被点赞数量。</p>
<ul>
<li><p>通过 RedisTemplate 对象的 <code>execute</code> 方法实现事务，保证被点赞用户点和点赞用户的数据更新一致。通过 <code>isMember</code> 方法查询用户的点赞状态，之后通过 <code>mutli</code> 方法开启事务。</p>
</li>
<li><p>当用户已点赞时，调用 <code>remove</code> 方法将当前用户从点赞用户的集合中移除，调用 <code>decrement</code> 方法将被点赞用户的被点赞数减 1；当用户未点赞时，调用 <code>add</code> 方法将当前用户添加到点赞用户的集合，调用 <code>increment</code> 方法将被点赞用户的被点赞数加 1。</p>
</li>
</ul>
</li>
<li><p>增加 <code>findUserLikeCount</code> 方法，以用户 id 作为 key，调用 <code>get</code> 方法查询用户所获得的点赞数。</p>
</li>
</ul>
<p>在 LikeController 中给 <code>like</code> 方法增加 entityUserId 参数即可。</p>
<hr>
<h3 id="关注"><a href="#关注" class="headerlink" title="关注"></a>关注</h3><p>在 RedisUnitl 工具类</p>
<ul>
<li><p>新增用户关注实体（帖子、评论、用户等）和粉丝（用户）的前缀常量 <code>followee</code> 和 <code>follower</code></p>
</li>
<li><p>新增 <code>getFolloweeKey(int userId, int entityType)</code> 方法，通过用户 id 和实体类型生成用户关注实体的 key。</p>
</li>
<li><p>新增 <code>getFollowerKey(int entityType, int entityId)</code> 方法，通过实体类型和实体 id 生成实体用户粉丝的 key。</p>
</li>
</ul>
<p>创建业务层的 FollowService 类</p>
<ul>
<li>新增 <code>follow</code> 方法，当用户关注某实体时，<ul>
<li>调用 <code>add</code> 方法将当前实体 id  和时间作为 value 和 score加入用户的关注集合。</li>
<li>调用 <code>add</code> 方法将当前用户 id 和时间作为 value 和 score 加入实体的粉丝集合。</li>
</ul>
</li>
<li>新增 <code>unfollow</code> 方法，当用户取消关注某实体时，<ul>
<li>调用 <code>remove</code> 方法将当前实体从用户的关注集合移除。</li>
<li>调用 <code>remove</code> 方法将用户从实体的粉丝集合移除。</li>
</ul>
</li>
</ul>
<hr>
<h3 id="个人主页"><a href="#个人主页" class="headerlink" title="个人主页"></a>个人主页</h3><p>在业务层的 FollowService 类</p>
<ul>
<li>新增 <code>findFolloweeCount</code> 方法，调用 zset 的 <code>zcard</code>  方法查询某用户关注的实体数量。</li>
<li>新增 <code>findFollowerCount</code> 方法，调用 zset 的 <code>zcard</code>  方法查询某实体的粉丝数量。</li>
<li>新增 <code>hasFollowed</code> 方法，根据 zset 的 <code>zscore</code>  方法返回值查询当前用户是否关注某实体。</li>
</ul>
<p>在 UserController 中新增 <code>getProfilePage</code> 方法获取个人主页。</p>
<ul>
<li>调用 LikeService 的  <code>findUserLikeCount</code> 查询用户获赞数，并添加到 Model 中。</li>
<li>调用 FollowService 的<code>findFolloweeCount</code>、<code>findFollowerCount</code> 、<code>hasFollowed</code> 方法分别查询关注数量、粉丝数量、用户是否关注三项信息并添加到 Model 对象中存储。</li>
</ul>
<hr>
<h3 id="关注列表和粉丝列表"><a href="#关注列表和粉丝列表" class="headerlink" title="关注列表和粉丝列表"></a>关注列表和粉丝列表</h3><p>在业务层的 FollowService 类</p>
<ul>
<li>新增 <code>findFollowees</code> 方法，查询用户关注列表，主要通过 zset 的  <code>reverseRange</code> 获取 value 即关注用户的 userId，再查询出其 user，之后通过 <code>score</code> 获取关注时间，存入 map 集合，将 map 添加到 list 列表返回。</li>
<li>新增 <code>findFollowers</code> 方法，查询用户粉丝列表，主要通过 zset 的  <code>reverseRange</code> 获取 value 即粉丝的 userId，再查询出其 user，之后通过 <code>score</code> 获取关注时间，存入 map 集合，将 map 添加到 list 列表返回。</li>
</ul>
<p>在表现层的 FollowController 类</p>
<ul>
<li>新增 <code>getFollowees</code> 方法，获取关注列表，存入 Model 对象。</li>
<li>新增 <code>getFollowers</code> 方法，获取粉丝列表，存入 Model 对象。</li>
</ul>
<hr>
<h3 id="优化登录模块"><a href="#优化登录模块" class="headerlink" title="优化登录模块"></a>优化登录模块</h3><p><strong>存储验证码</strong></p>
<p>在 RedisUntil 工具类</p>
<ul>
<li>新增验证码前缀常量 <code>kaptcha</code></li>
<li>新增 <code>getKaptchaKey</code> 方法，通过一个用户凭证（由于未登录，利用 cookie 实现）获得对应验证码的 key 值（利用 string 存储验证码）。</li>
</ul>
<p>在表现层的 LoginController 类</p>
<ul>
<li>重构 <code>getKaptcha</code> 方法，将验证码存入 redis，key 值是当前随机生成的一个字符串，同时将该字符串存入 cookie。</li>
<li>重构 <code>login</code> 方法，从 cookie 中获得随机字符串，生成验证码的 key 值，然后获取对应的 value 值即验证码。</li>
</ul>
<hr>
<p><strong>存储登录凭证</strong></p>
<p>在 RedisUntil 工具类</p>
<ul>
<li>新增登录凭证前缀常量 <code>ticket</code></li>
<li>新增 <code>getTicketKey</code> 方法，通过字符串获得登录凭证的对应 key 值（利用 string 存储）。</li>
</ul>
<p>在业务层的 UserService 类</p>
<ul>
<li>重构 <code>login</code> 方法，将登录凭证存入 redis 中。</li>
<li>重构 <code>logout</code> 方法，先从 redis 中获取登录凭证对象，将状态设为无效再重新存储进 redis。</li>
<li>重构 <code>findLoginTicket</code> 方法，根据 ticket 字符串获得对应登录凭证的 key，然后从 redis 查询登录凭证。</li>
</ul>
<hr>
<p><strong>缓存用户信息</strong></p>
<p>在 RedisUntil 工具类</p>
<ul>
<li>新增用户前缀常量 <code>user</code></li>
<li>新增 <code>getUserKey</code> 方法，通过用户 id 获得用户的对应 key 值（利用 string 存储）。</li>
</ul>
<p>在业务层的 UserService 类</p>
<ul>
<li><p>新增 <code>getCache</code>，从缓存获取用户信息。</p>
</li>
<li><p>新增 <code>initCache</code>，从 MySQL 查询用户信息并存入 redis。</p>
</li>
<li><p>新增 <code>clearCache</code>，用户信息变更（更新头像，激活）时清除缓存。</p>
</li>
<li><p>重构 <code>findUserById</code> 方法，首先调用 <code>getCache</code>从缓存获取用户信息，如果获取为 null 则调用 <code>initCache</code>。</p>
</li>
</ul>
<hr>
<h2 id="Kafka"><a href="#Kafka" class="headerlink" title="Kafka"></a>Kafka</h2><h3 id="发送系统通知"><a href="#发送系统通知" class="headerlink" title="发送系统通知"></a>发送系统通知</h3><p>在 CommunityConstant 接口中新增三个常量，代表三个主题：评论、点赞、关注。</p>
<p>创建 Event 类，封装事件对象，包括主题、用户 id、实体类型、实体 id、实体用户 id 以及一个 map 集合存放其它信息。</p>
<h4 id="触发事件"><a href="#触发事件" class="headerlink" title="触发事件"></a>触发事件</h4><p>创建 EventProducer 事件生产者，新增 <code>fireEvent(Event event)</code> 方法，通过 Event 获取事件类型，并将其封装成 JSON 数据，然后调用注入的 KafkaTemplate 实例的 send 方法发送。</p>
<p>在 CommentController、LikeControler、FollowController 中注入 EventProducer 实例，分别重构 <code>addComment</code> 方法、<code>like</code> 方法、<code>follow</code> 方法，封装 Event 对象，然后调用 EventProducer 的<code>fireEvent</code> 方法发布通知。</p>
<h4 id="消费事件"><a href="#消费事件" class="headerlink" title="消费事件"></a>消费事件</h4><p>创建 EventConsumer 事件消费者，消费者是被动触发的。</p>
<ul>
<li>注入 MessageService 实例。</li>
<li>增加 <code>handleCommentMessage(ConsumerRecord record)</code> 方法，通过 <code>@KafkaListener</code> 注解，topic 包括了评论、点赞和关注。从 recored 中获取信息，封装成 Message 对象然后调用 <code>addMessage</code> 方法插入数据库。</li>
</ul>
<p>【问题】没有向数据库插入系统通知记录，原因是 ServiceLogAspect 类进行日志处理时要获取 ServletRequestAttributes 请求对象，Kafka 的消费事件是自动触发的，没有进行新的请求，产生了请求对象的空指针异常。</p>
<hr>
<h3 id="显示系统通知"><a href="#显示系统通知" class="headerlink" title="显示系统通知"></a>显示系统通知</h3><h4 id="通知列表"><a href="#通知列表" class="headerlink" title="通知列表"></a>通知列表</h4><p>在 MessageMapper 接口中</p>
<ul>
<li><p>新增 <code>selectLatestNotice(int userId, String topic)</code> 方法，查询某主题最新的通知。</p>
</li>
<li><p>新增 <code>selectNoticeCount(int userId, String topic)</code> 方法，查询某主题通知的数量。</p>
</li>
<li><p>新增 <code>selectNoticeUnreadCount(int userId, String topic)</code> 方法，查询未读通知的数量。</p>
</li>
<li><p>在 <code>message-mapper.xml</code> 配置三个方法的 sql 语句，其中查询未读通知时使用 if 动态语句，如果没有传入 topic 就查询未读总量。</p>
</li>
</ul>
<p>在业务层的 MessageService 中</p>
<ul>
<li>新增 <code>findLatestNotice</code> 方法，调用 <code>selectLatestNotice</code> 方法查询最新通知。</li>
<li>新增 <code>findNoticeCount</code> 方法，调用 <code>selectNoticeCount</code> 方法查询某主题通知的数量。</li>
<li>新增 <code>findNoticeUnreadCount</code> 方法，调用 <code>selectNoticeUnreadCount</code> 方法查询未读通知的数量。</li>
</ul>
<p>在表现层的 MessageController 中新增 <code>getNoticeList</code> 方法，获取通知列表</p>
<ul>
<li>调用业务层 MessageService 的方法查询评论、点赞、关注的通知，将其封装在一个 HashMap 集合中然后添加到 Model 对象里。</li>
<li>调用业务层 MessageService 的方法查询私信和通知的总未读数量，添加到 Model 对象里。</li>
<li>返回 <code>notice.html</code> 页面。</li>
</ul>
<hr>
<h4 id="显示通知详情"><a href="#显示通知详情" class="headerlink" title="显示通知详情"></a>显示通知详情</h4><p>在 MessageMapper 接口新增 <code>selectNotices</code> 方法，查询某个主题的通知列表，在 <code>message-mapper.xml</code> 配置 SQL。</p>
<p>在业务层的 MessageService 中新增 <code>findNotices</code> 方法，调用 <code>selectNotices</code> 方法。</p>
<p>在表现层的 MessageController 中新增 <code>getNoticeDetail</code> 方法</p>
<ul>
<li>调用 <code>findNotices</code> 方法获取通知列表详情，封装到 List 集合并存入 Model 对象。</li>
<li>从通知集合中获取 id 集合，调用 <code>readMessage</code> 方法将消息设为已读。</li>
<li>返回 <code>notice-detail.html</code> 页面。</li>
</ul>
<hr>
<h4 id="显示未读通知总数"><a href="#显示未读通知总数" class="headerlink" title="显示未读通知总数"></a>显示未读通知总数</h4><p>创建 MessageInterceptor 拦截器</p>
<ul>
<li>注入 MessageService 实例和 HostHolder 实例。</li>
<li>重写 <code>postHandle</code> 方法，查询私信和通知的未读数量和，然后添加到 ModelAndView 对象。</li>
</ul>
<p>在 WebConfig 中注入 MessageInterceptor 实例，并在 <code>addInterceptors</code> 方法中添加该拦截器。</p>
<hr>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/11/01/%E8%AE%BA%E5%9D%9B%E7%9A%84%E6%80%BB%E7%BB%93%E5%92%8C%E6%94%B9%E8%BF%9B/" rel="next" title="论坛的总结和改进">
                <i class="fa fa-chevron-left"></i> 论坛的总结和改进
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/11/02/%E4%BA%8B%E5%8A%A1%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/" rel="prev" title="事务的实现原理">
                事务的实现原理 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  
    <div class="comments" id="comments">
      <div id="vcomments"></div>
    </div>
  


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avator.png"
                alt="John Doe" />
            
              <p class="site-author-name" itemprop="name">John Doe</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">
          <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=86 src="//music.163.com/outchain/player?type=2&id=442319&auto=1&height=66"></iframe>

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%7C%7C%20archive">
              
                  <span class="site-state-item-count">212</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            


            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">23</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            


          </nav>

          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#数据库表"><span class="nav-number">1.</span> <span class="nav-text">数据库表</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#用户表-user"><span class="nav-number">1.0.1.</span> <span class="nav-text">用户表 user</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#评论表-comment"><span class="nav-number">1.0.2.</span> <span class="nav-text">评论表 comment</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#帖子表-discuss-post"><span class="nav-number">1.0.3.</span> <span class="nav-text">帖子表 discuss_post</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#用户登录凭证表-login-ticket"><span class="nav-number">1.0.4.</span> <span class="nav-text">用户登录凭证表 login_ticket</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#消息表-message"><span class="nav-number">1.0.5.</span> <span class="nav-text">消息表 message</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#开发社区首页"><span class="nav-number">2.</span> <span class="nav-text">开发社区首页</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#搭建基本环境"><span class="nav-number">2.1.</span> <span class="nav-text">搭建基本环境</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#开发社区首页（discuss-post-表）"><span class="nav-number">2.2.</span> <span class="nav-text">开发社区首页（discuss_post 表）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#开发数据层"><span class="nav-number">2.2.1.</span> <span class="nav-text">开发数据层</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#开发业务层"><span class="nav-number">2.2.2.</span> <span class="nav-text">开发业务层</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#开发视图层"><span class="nav-number">2.2.3.</span> <span class="nav-text">开发视图层</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#开发分页组件"><span class="nav-number">2.2.4.</span> <span class="nav-text">开发分页组件</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#开发注册登录模块"><span class="nav-number">3.</span> <span class="nav-text">开发注册登录模块</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#发送邮件"><span class="nav-number">3.1.</span> <span class="nav-text">发送邮件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#注册功能"><span class="nav-number">3.2.</span> <span class="nav-text">注册功能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#生成验证码"><span class="nav-number">3.3.</span> <span class="nav-text">生成验证码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#登录退出功能（login-ticket-表）"><span class="nav-number">3.4.</span> <span class="nav-text">登录退出功能（login_ticket 表）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#显示登录信息"><span class="nav-number">3.5.</span> <span class="nav-text">显示登录信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#上传头像"><span class="nav-number">3.6.</span> <span class="nav-text">上传头像</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#修改密码"><span class="nav-number">3.7.</span> <span class="nav-text">修改密码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#检查登录状态"><span class="nav-number">3.8.</span> <span class="nav-text">检查登录状态</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#开发核心功能"><span class="nav-number">4.</span> <span class="nav-text">开发核心功能</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#敏感词过滤"><span class="nav-number">4.1.</span> <span class="nav-text">敏感词过滤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#发布帖子"><span class="nav-number">4.2.</span> <span class="nav-text">发布帖子</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#显示帖子内容"><span class="nav-number">4.3.</span> <span class="nav-text">显示帖子内容</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#显示评论（comment-表）"><span class="nav-number">4.4.</span> <span class="nav-text">显示评论（comment 表）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#添加评论"><span class="nav-number">4.5.</span> <span class="nav-text">添加评论</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#显示私信列表-（message-表）"><span class="nav-number">4.6.</span> <span class="nav-text">显示私信列表 （message 表）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#发送私信"><span class="nav-number">4.7.</span> <span class="nav-text">发送私信</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#统一异常处理"><span class="nav-number">4.8.</span> <span class="nav-text">统一异常处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#统一日志处理"><span class="nav-number">4.9.</span> <span class="nav-text">统一日志处理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis"><span class="nav-number">5.</span> <span class="nav-text">Redis</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#点赞"><span class="nav-number">5.1.</span> <span class="nav-text">点赞</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#收到的赞"><span class="nav-number">5.2.</span> <span class="nav-text">收到的赞</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#关注"><span class="nav-number">5.3.</span> <span class="nav-text">关注</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#个人主页"><span class="nav-number">5.4.</span> <span class="nav-text">个人主页</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#关注列表和粉丝列表"><span class="nav-number">5.5.</span> <span class="nav-text">关注列表和粉丝列表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#优化登录模块"><span class="nav-number">5.6.</span> <span class="nav-text">优化登录模块</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Kafka"><span class="nav-number">6.</span> <span class="nav-text">Kafka</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#发送系统通知"><span class="nav-number">6.1.</span> <span class="nav-text">发送系统通知</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#触发事件"><span class="nav-number">6.1.1.</span> <span class="nav-text">触发事件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#消费事件"><span class="nav-number">6.1.2.</span> <span class="nav-text">消费事件</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#显示系统通知"><span class="nav-number">6.2.</span> <span class="nav-text">显示系统通知</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#通知列表"><span class="nav-number">6.2.1.</span> <span class="nav-text">通知列表</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#显示通知详情"><span class="nav-number">6.2.2.</span> <span class="nav-text">显示通知详情</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#显示未读通知总数"><span class="nav-number">6.2.3.</span> <span class="nav-text">显示未读通知总数</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>

  
</div>

<!--

  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.3</div>
-->




    <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">博客全站共355k字</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.3"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  






  
  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/valine@1.1.4/dist/Valine.min.js"></script>
  <script type="text/javascript">
    new Valine({
        av: AV,
        el: '#vcomments' ,
        verify: false,
        notify: false,
        app_id: 'poAXA1bCt4bcaGmuoHBrU52s-gzGzoHsz',
        app_key: 'ARaHT9OThVx8QqybEjteIed2',
        placeholder: 'Comment input placeholder'
    });
  </script>




  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "./public/search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  





<script type="text/javascript"
color="0,0,255" opacity='0.7' zIndex="-2" count="30" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>


<script type="text/javascript" src="/js/src/clicklove.js"></script>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
